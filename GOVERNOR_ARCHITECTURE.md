# Governor Architecture Diagram

## High-Level Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                         User Query                               │
│                  "What's 15% tip on $47.50?"                     │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      dialogue_core.c                             │
│  ┌────────────────────────────────────────────────────────┐     │
│  │  Intent Pattern Matching (Simple Queries)              │     │
│  │  - "set timer"                                         │     │
│  │  - "play music"                                        │     │
│  │  - "what time is it"                                   │     │
│  └────────────────────────────────────────────────────────┘     │
│                              │                                   │
│                              │ Complex Query / Low Confidence    │
│                              ▼                                   │
│  ┌────────────────────────────────────────────────────────┐     │
│  │           Governor Orchestration                       │     │
│  │  ┌──────────────────────────────────────────────┐     │     │
│  │  │      Phi-3.5-mini-instruct (3.8B)            │     │     │
│  │  │  + System Prompt (KV-cached)                 │     │     │
│  │  │  + Tool Catalog                              │     │     │
│  │  └──────────────────────────────────────────────┘     │     │
│  │                      │                                 │     │
│  │                      │ Generates                       │     │
│  │                      ▼                                 │     │
│  │  ┌──────────────────────────────────────────────┐     │     │
│  │  │ <tool_call name="percentage_calculate"       │     │     │
│  │  │            value="47.50"                      │     │     │
│  │  │            percentage="15"                    │     │     │
│  │  │            operation="of" />                  │     │     │
│  │  │ <confidence>95</confidence>                   │     │     │
│  │  └──────────────────────────────────────────────┘     │     │
│  │                      │                                 │     │
│  │                      │ Parse & Execute                 │     │
│  │                      ▼                                 │     │
│  │  ┌──────────────────────────────────────────────┐     │     │
│  │  │      Tool Registry (Dynamic Array)           │     │     │
│  │  │  ┌────────────────────────────────────┐      │     │     │
│  │  │  │ ⚡ calculator_compute               │      │     │     │
│  │  │  │    - Math parser (0.5ms)           │      │     │     │
│  │  │  │    - Deterministic                 │      │     │     │
│  │  │  └────────────────────────────────────┘      │     │     │
│  │  │  ┌────────────────────────────────────┐      │     │     │
│  │  │  │ ⚡ percentage_calculate             │◄─────┤──── Execute
│  │  │  │    - 4 operations (0.3ms)          │      │     │     │
│  │  │  │    - Deterministic                 │      │     │     │
│  │  │  └────────────────────────────────────┘      │     │     │
│  │  │  ┌────────────────────────────────────┐      │     │     │
│  │  │  │ ⚡ unit_converter (TODO)            │      │     │     │
│  │  │  └────────────────────────────────────┘      │     │     │
│  │  └──────────────────────────────────────────────┘     │     │
│  │                      │                                 │     │
│  │                      │ {"result": 7.12}                │     │
│  │                      ▼                                 │     │
│  │  ┌──────────────────────────────────────────────┐     │     │
│  │  │  Confidence Check                            │     │     │
│  │  │  0.95 >= 0.85 threshold? ✓                   │     │     │
│  │  └──────────────────────────────────────────────┘     │     │
│  └────────────────────────────────────────────────────────┘     │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                         Response                                 │
│              "The 15% tip on $47.50 is $7.12"                    │
└─────────────────────────────────────────────────────────────────┘
```

## Governor Iteration Loop

```
┌─────────────┐
│ User Query  │
└──────┬──────┘
       │
       ▼
┌──────────────────────────────────────────────────────────┐
│ ITERATION 1                                              │
│                                                          │
│  ┌────────────────────────────────────────┐             │
│  │ LLM: Phi-3.5-mini-instruct             │             │
│  │ Input: User query + System prompt      │             │
│  └────────────┬───────────────────────────┘             │
│               │                                          │
│               ▼                                          │
│  ┌────────────────────────────────────────┐             │
│  │ Response:                              │             │
│  │ <tool_call name="calc" expr="5+5" />   │             │
│  │ <confidence>60</confidence>            │             │
│  └────────────┬───────────────────────────┘             │
│               │                                          │
│               ▼                                          │
│  ┌────────────────────────────────────────┐             │
│  │ Parse:                                 │             │
│  │ - Confidence: 0.60 < 0.85 (threshold)  │             │
│  │ - Tool calls: 1 found                  │             │
│  └────────────┬───────────────────────────┘             │
│               │                                          │
│               ▼                                          │
│  ┌────────────────────────────────────────┐             │
│  │ Execute Tool:                          │             │
│  │ calculator_compute("5+5")              │             │
│  │ → {"result": 10}                       │             │
│  └────────────┬───────────────────────────┘             │
└───────────────┼──────────────────────────────────────────┘
                │
                ▼
┌──────────────────────────────────────────────────────────┐
│ ITERATION 2                                              │
│                                                          │
│  ┌────────────────────────────────────────┐             │
│  │ LLM: Phi-3.5-mini-instruct             │             │
│  │ Input: Previous + Tool result          │             │
│  │ <tool_result>{"result": 10}</...>      │             │
│  └────────────┬───────────────────────────┘             │
│               │                                          │
│               ▼                                          │
│  ┌────────────────────────────────────────┐             │
│  │ Response:                              │             │
│  │ The answer is 10.                      │             │
│  │ <confidence>95</confidence>            │             │
│  └────────────┬───────────────────────────┘             │
│               │                                          │
│               ▼                                          │
│  ┌────────────────────────────────────────┐             │
│  │ Parse:                                 │             │
│  │ - Confidence: 0.95 >= 0.85 ✓           │             │
│  │ - Tool calls: 0                        │             │
│  └────────────┬───────────────────────────┘             │
│               │                                          │
│               ▼                                          │
│  ┌────────────────────────────────────────┐             │
│  │ RETURN SUCCESS                         │             │
│  │ Status: GOVERNOR_SUCCESS               │             │
│  │ Iterations: 2                          │             │
│  │ Tools called: 1                        │             │
│  └────────────┬───────────────────────────┘             │
└───────────────┼──────────────────────────────────────────┘
                │
                ▼
         ┌──────────────┐
         │   Response   │
         │ "The answer  │
         │   is 10."    │
         └──────────────┘
```

## KV Cache Optimization

```
┌─────────────────────────────────────────────────────────────────┐
│                    App Startup (Once)                            │
│                                                                  │
│  ┌────────────────────────────────────────────────────────┐     │
│  │ Load Phi-3.5-mini-instruct GGUF                        │     │
│  │ Size: ~2GB (Q4_K_M quantization)                       │     │
│  └────────────┬───────────────────────────────────────────┘     │
│               │                                                  │
│               ▼                                                  │
│  ┌────────────────────────────────────────────────────────┐     │
│  │ Build System Prompt                                    │     │
│  │ - Governor identity                                    │     │
│  │ - Tool catalog (calculator, percentage, etc.)          │     │
│  │ - XML format instructions                              │     │
│  │ - Confidence requirement                               │     │
│  │ Size: ~1KB text → ~300 tokens                          │     │
│  └────────────┬───────────────────────────────────────────┘     │
│               │                                                  │
│               ▼                                                  │
│  ┌────────────────────────────────────────────────────────┐     │
│  │ Process System Prompt                                  │     │
│  │ llama_tokenize()      → [t1, t2, ..., t300]            │     │
│  │ llama_decode()        → Process through model          │     │
│  │ llama_kv_cache_save() → Cache activations              │     │
│  │                                                         │     │
│  │ Result: system_prompt_token_count = 300                │     │
│  └────────────┬───────────────────────────────────────────┘     │
└───────────────┼──────────────────────────────────────────────────┘
                │
                │ KV Cache Now Contains:
                │ ┌──────────────────────────────────────┐
                │ │ [t1] [t2] ... [t300]                 │
                │ │  ^                                   │
                │ │  └── System prompt cached            │
                │ └──────────────────────────────────────┘
                │
                ▼
┌─────────────────────────────────────────────────────────────────┐
│                  Query 1: "Calculate 5+5"                        │
│                                                                  │
│  ┌────────────────────────────────────────────────────────┐     │
│  │ Tokenize User Query                                    │     │
│  │ "Calculate 5+5" → [t301, t302, t303]                   │     │
│  └────────────┬───────────────────────────────────────────┘     │
│               │                                                  │
│               ▼                                                  │
│  ┌────────────────────────────────────────────────────────┐     │
│  │ Append to KV Cache                                     │     │
│  │ Start at position: system_prompt_token_count (300)     │     │
│  │                                                         │     │
│  │ Before: [t1] ... [t300]                                │     │
│  │ After:  [t1] ... [t300] [t301] [t302] [t303]           │     │
│  └────────────┬───────────────────────────────────────────┘     │
│               │                                                  │
│               ▼                                                  │
│  ┌────────────────────────────────────────────────────────┐     │
│  │ Generate Response                                      │     │
│  │ Only processes NEW tokens (t301, t302, t303)           │     │
│  │ Reuses cached activations for system prompt            │     │
│  │ Speedup: ~10x faster than re-processing everything     │     │
│  └────────────┬───────────────────────────────────────────┘     │
└───────────────┼──────────────────────────────────────────────────┘
                │
                ▼
┌─────────────────────────────────────────────────────────────────┐
│               Query 2: "What's 15% of $47.50?"                   │
│                                                                  │
│  ┌────────────────────────────────────────────────────────┐     │
│  │ Reset KV Cache                                         │     │
│  │ llama_kv_cache_seq_rm(ctx, 0, 300, -1)                 │     │
│  │ Removes everything after position 300                  │     │
│  │                                                         │     │
│  │ Before: [t1] ... [t300] [t301] [t302] [t303]           │     │
│  │ After:  [t1] ... [t300]                                │     │
│  │               ^                                         │     │
│  │               └── System prompt STILL CACHED            │     │
│  └────────────┬───────────────────────────────────────────┘     │
│               │                                                  │
│               ▼                                                  │
│  ┌────────────────────────────────────────────────────────┐     │
│  │ Append New Query                                       │     │
│  │ "What's 15% of $47.50?" → [t304, t305, t306, ...]      │     │
│  │                                                         │     │
│  │ Result: [t1] ... [t300] [t304] [t305] [t306] ...       │     │
│  └────────────┬───────────────────────────────────────────┘     │
│               │                                                  │
│               ▼                                                  │
│  ┌────────────────────────────────────────────────────────┐     │
│  │ Generate Response                                      │     │
│  │ Again, only processes NEW tokens                       │     │
│  │ System prompt cached activations reused                │     │
│  └────────────────────────────────────────────────────────┘     │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                     Performance Impact                           │
│                                                                  │
│  WITHOUT KV Cache (re-process everything):                      │
│  ─────────────────────────────────────────                       │
│  System Prompt: 300 tokens × 300ms/token = 90 seconds           │
│  User Query:      3 tokens × 300ms/token =  0.9 seconds         │
│  TOTAL: ~91 seconds                                             │
│                                                                  │
│  WITH KV Cache (reuse system prompt):                           │
│  ──────────────────────────────────────                          │
│  System Prompt: CACHED (processed once at startup)              │
│  User Query:      3 tokens × 300ms/token =  0.9 seconds         │
│  TOTAL: ~1 second                                               │
│                                                                  │
│  SPEEDUP: ~90x for this example!                                │
│                                                                  │
│  Real-world speedup: ~10x (system prompt is shorter than        │
│  shown here, but still significant savings)                     │
└─────────────────────────────────────────────────────────────────┘
```

## Tool Execution Flow

```
┌─────────────────────────────────────────────────────────────────┐
│ LLM Response:                                                    │
│ <tool_call name="calculator_compute" expression="47.50*0.15" /> │
│ <tool_call name="percentage_calculate" value="100"              │
│            percentage="20" operation="of" />                     │
│ <confidence>85</confidence>                                      │
└──────────────────────┬──────────────────────────────────────────┘
                       │
                       ▼
         ┌─────────────────────────────┐
         │ extract_tool_calls()        │
         │ Find all <tool_call ... />  │
         └────────┬────────────────────┘
                  │
                  ├────────────────┬────────────────┐
                  ▼                ▼                │
         Tool Call #1     Tool Call #2              │
                  │                │                │
                  ▼                ▼                │
    ┌──────────────────┐ ┌──────────────────┐      │
    │ parse_attribute()│ │ parse_attribute()│      │
    │ name="calculator"│ │ name="percentage"│      │
    │ expr="47.50*..."│ │ value="100"      │      │
    └────────┬─────────┘ └────────┬─────────┘      │
             │                    │                │
             ▼                    ▼                │
    ┌──────────────────┐ ┌──────────────────┐      │
    │ Build JSON:      │ │ Build JSON:      │      │
    │ {                │ │ {                │      │
    │  "expression":   │ │  "value": 100,   │      │
    │  "47.50*0.15"    │ │  "percentage":20,│      │
    │ }                │ │  "operation":"of"│      │
    └────────┬─────────┘ └────────┬─────────┘      │
             │                    │                │
             ▼                    ▼                │
    ┌──────────────────┐ ┌──────────────────┐      │
    │ Find in Registry │ │ Find in Registry │      │
    │ calculator_      │ │ percentage_      │      │
    │ compute          │ │ calculate        │      │
    └────────┬─────────┘ └────────┬─────────┘      │
             │                    │                │
             ▼                    ▼                │
    ┌──────────────────┐ ┌──────────────────┐      │
    │ Execute:         │ │ Execute:         │      │
    │ parse_expression │ │ percentage_of    │      │
    │ eval(47.50*0.15) │ │ 100 * 20 / 100   │      │
    │ = 7.125          │ │ = 20.00          │      │
    └────────┬─────────┘ └────────┬─────────┘      │
             │                    │                │
             ▼                    ▼                │
    ┌──────────────────┐ ┌──────────────────┐      │
    │ Return JSON:     │ │ Return JSON:     │      │
    │ {"result":7.125} │ │ {"result":20.00} │      │
    └────────┬─────────┘ └────────┬─────────┘      │
             │                    │                │
             └────────────┬───────┘                │
                          ▼                        │
              ┌───────────────────────┐            │
              │ Append to Conversation│            │
              │ <tool_result>         │            │
              │  {"result": 7.125}    │            │
              │ </tool_result>        │            │
              │ <tool_result>         │            │
              │  {"result": 20.00}    │            │
              │ </tool_result>        │            │
              └───────────┬───────────┘            │
                          │                        │
                          ▼                        │
              ┌───────────────────────┐            │
              │ Next Iteration:       │            │
              │ Submit to LLM with    │            │
              │ tool results          │            │
              └───────────────────────┘            │
```

## Memory Layout

```
┌─────────────────────────────────────────────────────────────────┐
│                    Governor State (~4KB)                         │
│ ┌──────────────────────────────────────────────────────────┐    │
│ │ struct ethervox_governor {                               │    │
│ │   config                      (20 bytes)                 │    │
│ │   tool_registry*              (8 bytes pointer)          │    │
│ │   llm_ctx*                    (8 bytes pointer)          │    │
│ │   llm_model*                  (8 bytes pointer)          │    │
│ │   system_prompt_tokens        (4 bytes)                  │    │
│ │   last_iteration_count        (4 bytes)                  │    │
│ │   initialized                 (1 byte)                   │    │
│ │ }                                                         │    │
│ └──────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                  Tool Registry (~8KB default)                    │
│ ┌──────────────────────────────────────────────────────────┐    │
│ │ struct ethervox_tool_registry {                          │    │
│ │   tools*      → ┌─────────────────────────────────┐      │    │
│ │                 │ Tool #0: calculator_compute     │      │    │
│ │                 │   name[64]           (64 bytes) │      │    │
│ │                 │   description[256]  (256 bytes) │      │    │
│ │                 │   schema[1024]     (1024 bytes) │      │    │
│ │                 │   execute*            (8 bytes) │      │    │
│ │                 │   metadata           (13 bytes) │      │    │
│ │                 │ TOTAL: ~1365 bytes per tool     │      │    │
│ │                 ├─────────────────────────────────┤      │    │
│ │                 │ Tool #1: percentage_calculate   │      │    │
│ │                 │ (~1365 bytes)                   │      │    │
│ │                 ├─────────────────────────────────┤      │    │
│ │                 │ ...                             │      │    │
│ │                 │ Capacity: 16 tools              │      │    │
│ │                 │ Total: ~21KB allocated          │      │    │
│ │                 └─────────────────────────────────┘      │    │
│ │   tool_count   (4 bytes)                                 │    │
│ │   capacity     (4 bytes)                                 │    │
│ │ }                                                         │    │
│ └──────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                  llama.cpp Context (~2.5GB)                      │
│ ┌──────────────────────────────────────────────────────────┐    │
│ │ Model Weights:                          ~2.0 GB          │    │
│ │   - Phi-3.5-mini-instruct (Q4_K_M)                       │    │
│ │   - 3.8B parameters quantized to 4-bit                   │    │
│ │                                                           │    │
│ │ KV Cache:                               ~256 MB          │    │
│ │   - 128K context window                                  │    │
│ │   - 32 layers × 3072 dimensions                          │    │
│ │   - Float16 precision                                    │    │
│ │                                                           │    │
│ │ Working Memory:                         ~200 MB          │    │
│ │   - Inference buffers                                    │    │
│ │   - Temporary activations                                │    │
│ │                                                           │    │
│ │ TOTAL: ~2.5 GB                                           │    │
│ └──────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│              Conversation History (Dynamic, ~8KB)                │
│ ┌──────────────────────────────────────────────────────────┐    │
│ │ <user>What's 15% tip on $47.50?</user>                   │    │
│ │ <tool_call name="percentage_calculate" ... />            │    │
│ │ <tool_result>{"result": 7.12}</tool_result>              │    │
│ │ <confidence>95</confidence>                              │    │
│ │ The 15% tip would be $7.12.                              │    │
│ └──────────────────────────────────────────────────────────┘    │
│                                                                  │
│ Grows with each iteration, pruned after response                │
└─────────────────────────────────────────────────────────────────┘
```
